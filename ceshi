#!/bin/bash

# 确保以 root 权限运行
if [ "$EUID" -ne 0 ]; then 
  echo "请使用 root 权限运行此脚本 (sudo -i)"
  exit 1
fi

# 检查并安装必要的交互工具
if ! command -v whiptail &> /dev/null; then
    apt-get update && apt-get install -y whiptail
fi

# --- 菜单选择 ---
CHOICES=$(whiptail --title "VPS 自动化部署脚本" --checklist \
"使用空格键选择项目，回车确认安装：" 18 65 6 \
"BBR" "开启内核 BBR 加速" ON \
"DOCKER" "安装 Docker & Compose" ON \
"FRPS" "部署 frps 服务端" OFF \
"WXCHAT" "部署微信转发代理" OFF 3>&1 1>&2 2>&3)

exitstatus=$?
if [ $exitstatus != 0 ]; then exit 0; fi

# --- 功能实现 ---

# 1. BBR
if [[ $CHOICES == *"BBR"* ]]; then
    echo ">>> 正在开启 BBR..."
    if ! grep -q "net.core.default_qdisc=fq" /etc/sysctl.conf; then
        echo "net.core.default_qdisc=fq" >> /etc/sysctl.conf
        echo "net.ipv4.tcp_congestion_control=bbr" >> /etc/sysctl.conf
        sysctl -p
    fi
fi

# 2. Docker
if [[ $CHOICES == *"DOCKER"* ]]; then
    echo ">>> 正在安装 Docker..."
    if ! command -v docker &> /dev/null; then
        curl -fsSL https://get.docker.com | bash -s docker
        systemctl enable --now docker
    fi
fi

# 3. 容器部署准备
WORK_DIR="/opt/vps_services"
mkdir -p $WORK_DIR
cd $WORK_DIR

# 初始化 compose 文件
cat <<EOF > docker-compose.yml
version: '3.3'
services:
EOF

# 4. FRPS 逻辑
if [[ $CHOICES == *"FRPS"* ]]; then
    F_PORT=$(whiptail --inputbox "设置 frps 监听端口" 8 45 "7000" 3>&1 1>&2 2>&3)
    mkdir -p ./frp
    cat <<EOF > ./frp/frps.toml
bindPort = ${F_PORT:-7000}
auth.token = "MySecretToken123"
webServer.addr = "0.0.0.0"
webServer.port = 7500
webServer.user = "admin"
webServer.password = "admin888"
EOF
    cat <<EOF >> docker-compose.yml
  frps:
    image: fatedier/frps:latest
    container_name: frps
    restart: always
    network_mode: host
    volumes:
      - ./frp/frps.toml:/etc/frp/frps.toml
EOF
fi

# 5. WXCHAT 逻辑
if [[ $CHOICES == *"WXCHAT"* ]]; then
    W_PORT=$(whiptail --inputbox "设置 WXCHAT 外部端口" 8 45 "8088" 3>&1 1>&2 2>&3)
    cat <<EOF >> docker-compose.yml
  wxchat:
    image: 'ddsderek/wxchat:latest'
    container_name: wxchat
    restart: always
    ports:
      - '${W_PORT:-8088}:80'
EOF
fi

# 6. 启动容器
if [[ $CHOICES == *"FRPS"* ]] || [[ $CHOICES == *"WXCHAT"* ]]; then
    docker compose up -d
fi

whiptail --title "完成" --msgbox "所选组件已安装完成！" 8 45
